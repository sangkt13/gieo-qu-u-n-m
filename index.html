<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Gieo Qu·∫ª T√†i L·ªôc</title>
  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#9F1239" />
  <!-- Tailwind + Confetti + Font ƒë·∫πp -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&amp;family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    :root { --primary: #9F1239; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
      margin: 0;
      padding: env(safe-area-inset-top) 0;
    }
    .title-font { font-family: 'Playfair Display', serif; }
    .card {
      background: linear-gradient(135deg, #9F1239 0%, #4C1D95 100%);
      box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.4);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    .tube {
      width: 168px; height: 280px;
      background: linear-gradient(90deg, #78350f, #451a03, #78350f);
      border-radius: 18px 18px 60px 60px;
      border: 8px solid #3f2a1e;
      box-shadow: inset 0 0 40px rgba(0,0,0,0.7), 0 20px 25px -5px rgb(0 0 0 / 0.3);
      position: relative;
      overflow: hidden;
    }
    .tube::before {
      content: '';
      position: absolute;
      inset: 12px;
      border-radius: 10px;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.18), transparent 60%);
    }
    .stick {
      position: absolute;
      width: 6px;
      background: linear-gradient(#f5e8c7, #d97706, #f5e8c7);
      border-radius: 999px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3);
      transition: transform 0.3s ease;
    }
    .shaking .stick { animation: shakeStick 0.65s ease-in-out infinite; }
    @keyframes shakeStick {
      0%, 100% { transform: rotate(0deg) translateY(0); }
      25% { transform: rotate(14deg) translateY(-10px); }
      75% { transform: rotate(-14deg) translateY(8px); }
    }
    .modal {
      animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes modalPop {
      from { opacity: 0; transform: scale(0.75) translateY(50px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .result-number { font-size: 5.5rem; line-height: 1; font-weight: 900; }
  </style>
</head>
<body class="min-h-screen py-8">
  <div class="max-w-[460px] mx-auto px-4">
    <!-- Card ch√≠nh -->
    <div class="card rounded-3xl overflow-hidden text-white">
      <div class="px-6 pt-9 pb-6 text-center">
        <div class="flex items-center justify-center gap-3 mb-1">
          <div class="w-10 h-10 bg-amber-400 text-[#9F1239] rounded-2xl flex items-center justify-center text-3xl">ü™î</div>
          <h1 class="title-font text-4xl font-bold tracking-tight">Gieo Qu·∫ª</h1>
        </div>
        <p class="text-amber-200 text-lg">T√†i L·ªôc ‚Ä¢ May M·∫Øn ‚Ä¢ H∆∞·ªõng D·∫´n</p>
      </div>

      <!-- ·ªêng l·ªôc -->
      <div class="flex justify-center py-10 bg-white/10 mx-6 rounded-3xl">
        <div id="tube" class="tube flex items-center justify-center">
          <div id="sticks" class="absolute inset-x-4 top-14 flex justify-center gap-1"></div>
          <div class="text-center z-10">
            <div class="text-[46px] leading-none font-black text-amber-300 tracking-widest">L·ªòC</div>
          </div>
        </div>
      </div>

      <div class="px-6 pb-10">
        <button id="btnDraw"
          class="w-full bg-gradient-to-r from-amber-400 to-yellow-300 hover:from-amber-300 hover:to-yellow-200 text-[#9F1239] font-bold text-xl py-4.5 rounded-2xl shadow-lg active:scale-[0.97] transition-all flex items-center justify-center gap-3">
          <span class="text-2xl">üéã</span>
          <span>L·∫ÆC ·ªêNG GIEO QU·∫∫</span>
        </button>
        <p class="text-center text-white/70 text-sm mt-6">Ch·∫°m n√∫t ho·∫∑c l·∫Øc ƒëi·ªán tho·∫°i ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
      </div>
    </div>

    <!-- L·ªãch s·ª≠ -->
    <div id="historySection" class="mt-8 hidden">
      <div class="flex items-center justify-between mb-3 px-1">
        <h3 class="font-semibold text-gray-700">Qu·∫ª g·∫ßn ƒë√¢y</h3>
        <span id="historyCount" class="text-xs bg-white/70 text-gray-600 px-2.5 py-0.5 rounded-full"></span>
      </div>
      <div id="historyList" class="space-y-3"></div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="overlay" class="fixed inset-0 bg-black/75 hidden items-center justify-center z-50 p-4">
    <div id="modal" class="modal bg-white rounded-3xl max-w-md w-full overflow-hidden shadow-2xl">
      <!-- Header -->
      <div class="bg-gradient-to-r from-[#9F1239] to-violet-700 text-white px-6 py-6">
        <div class="flex justify-between">
          <div>
            <div class="uppercase tracking-widest text-amber-300 text-xs font-medium">K·∫øt qu·∫£</div>
            <div id="resultName" class="title-font text-3xl font-bold mt-1"></div>
          </div>
          <button id="btnClose" class="text-4xl leading-none hover:bg-white/20 w-10 h-10 flex items-center justify-center rounded-full transition">√ó</button>
        </div>
      </div>

      <div class="p-6">
        <div class="flex justify-center -mt-8 mb-4">
          <div id="resultBadge" class="px-6 py-2 text-lg font-bold rounded-full shadow-md"></div>
        </div>

        <div id="resultNumber" class="result-number text-center text-gray-900"></div>
        <div id="resultMeaning" class="text-gray-600 text-[15.5px] leading-relaxed text-center mt-3 min-h-[72px]"></div>

        <!-- AI -->
        <div class="mt-10 border-t pt-6">
          <div class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
            <span>‚ú®</span> H·ªèi AI v·ªÅ qu·∫ª n√†y
          </div>
          <textarea id="aiQuestion" rows="3" class="w-full border border-gray-200 focus:border-amber-400 rounded-2xl p-4 text-sm resize-none focus:outline-none" placeholder="V√≠ d·ª•: Qu·∫ª n√†y h·ª£p v·ªõi c√¥ng vi·ªác th√°ng n√†y kh√¥ng?"></textarea>
          <button id="btnAskAI" class="mt-4 w-full bg-[#9F1239] hover:bg-[#881337] text-white font-semibold py-3.5 rounded-2xl transition">H·ªèi AI Di·ªÖn Gi·∫£i</button>
          
          <div id="aiAnswerBox" class="hidden mt-6">
            <div class="text-xs text-gray-500 mb-2">TR·∫¢ L·ªúI T·ª™ AI</div>
            <div id="aiAnswer" class="bg-amber-50 border border-amber-100 rounded-2xl p-5 text-sm leading-relaxed whitespace-pre-wrap"></div>
          </div>
        </div>
      </div>

      <div class="border-t flex gap-3 p-4">
        <button id="btnDrawAgain" class="flex-1 py-3.5 text-gray-700 font-medium border border-gray-300 rounded-2xl hover:bg-gray-50 transition">Gieo qu·∫ª kh√°c</button>
        <button id="btnShare" class="flex-1 py-3.5 font-medium bg-gray-900 text-white rounded-2xl hover:bg-black transition">Chia s·∫ª</button>
      </div>
    </div>
  </div>

  <script>
    // ================== DATA 64 QU·∫∫ (m·∫´u + fallback) ==================
    const queDatabase = {
      1: { name: "C√†n Vi Thi√™n", meaning: "S·ª©c m·∫°nh s√°ng t·∫°o, kh√≠ th·∫ø ng√∫t tr·ªùi. ƒê·∫°i c√°t l·ªõn.", type: "ƒê·∫†I C√ÅT", color: "emerald" },
      2: { name: "Kh√¥n Vi ƒê·ªãa", meaning: "Ki√™n nh·∫´n, bao dung, t√≠ch ƒë·ª©c s·∫Ω ƒë∆∞·ª£c b√°o ƒë√°p.", type: "C√ÅT", color: "emerald" },
      11: { name: "Th√°i", meaning: "Th·ªãnh v∆∞·ª£ng, th√¥ng su·ªët, th·ªùi c∆° v√†ng.", type: "ƒê·∫†I C√ÅT", color: "emerald" },
      12: { name: "Bƒ©", meaning: "B·∫ø t·∫Øc t·∫°m th·ªùi, c·∫ßn ki√™n tr√¨ quan s√°t.", type: "C·∫®N TR·ªåNG", color: "amber" },
      43: { name: "Qu·∫£i", meaning: "Quy·∫øt ƒëo√°n lo·∫°i b·ªè ƒëi·ªÅu x·∫•u, th√†nh c√¥ng l·ªõn.", type: "C√ÅT", color: "emerald" },
      // Th√™m tho·∫£i m√°i... (b·∫°n c√≥ th·ªÉ b·ªï sung t·ª´ Kinh D·ªãch)
    };

    function getQueInfo(n) {
      if (queDatabase[n]) return queDatabase[n];
      const types = [
        {t: "ƒê·∫†I C√ÅT", c: "emerald"},
        {t: "C√ÅT", c: "emerald"},
        {t: "B√åNH AN", c: "amber"},
        {t: "C·∫®N TR·ªåNG", c: "orange"}
      ];
      const pick = types[Math.floor(Math.random() * types.length)];
      return {
        name: `Qu·∫ª ${n}`,
        meaning: "Th·ªùi v·∫≠n ƒëang chuy·ªÉn bi·∫øn t√≠ch c·ª±c. H√£y gi·ªØ t√¢m b√¨nh an v√† h√†nh ƒë·ªông ƒë√∫ng l√∫c.",
        type: pick.t,
        color: pick.c
      };
    }

    // ================== DOM & VARIABLES ==================
    const tube = document.getElementById('tube');
    const btnDraw = document.getElementById('btnDraw');
    const overlay = document.getElementById('overlay');
    const btnClose = document.getElementById('btnClose');
    const btnDrawAgain = document.getElementById('btnDrawAgain');
    const btnShare = document.getElementById('btnShare');

    const resultNumber = document.getElementById('resultNumber');
    const resultName = document.getElementById('resultName');
    const resultMeaning = document.getElementById('resultMeaning');
    const resultBadge = document.getElementById('resultBadge');

    const aiQuestion = document.getElementById('aiQuestion');
    const btnAskAI = document.getElementById('btnAskAI');
    const aiAnswerBox = document.getElementById('aiAnswerBox');
    const aiAnswer = document.getElementById('aiAnswer');

    let currentQue = null;

    // ================== T·∫†O QUE XƒÇM ==================
    function createSticks() {
      const container = document.getElementById('sticks');
      container.innerHTML = '';
      for (let i = 0; i < 7; i++) {
        const s = document.createElement('div');
        s.className = 'stick';
        s.style.height = `${160 + Math.random() * 35}px`;
        s.style.transform = `rotate(${-22 + Math.random() * 44}deg)`;
        s.style.left = `${28 + i * 7}%`;
        container.appendChild(s);
      }
    }

    function shake() {
      tube.classList.add('shaking');
      if ('vibrate' in navigator) navigator.vibrate([80, 40, 120]);
      setTimeout(() => tube.classList.remove('shaking'), 900);
    }

    // ================== MODAL ==================
    function openModal(que) {
      currentQue = que;
      resultNumber.textContent = que.id || que.number || que.num;
      resultName.textContent = que.name;
      resultMeaning.textContent = que.meaning;
      
      resultBadge.textContent = que.type;
      resultBadge.className = `px-6 py-2 text-lg font-bold rounded-full shadow-md bg-${que.color}-500 text-white`;

      // Confetti khi ƒê·∫°i C√°t
      if (que.type === "ƒê·∫†I C√ÅT") {
        confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 } });
      }

      overlay.classList.remove('hidden');
      overlay.classList.add('flex');
      aiQuestion.value = '';
      aiAnswerBox.classList.add('hidden');
    }

    function closeModal() {
      overlay.classList.add('hidden');
      overlay.classList.remove('flex');
    }

    // ================== GIEO QU·∫∫ ==================
    btnDraw.addEventListener('click', () => {
      shake();
      setTimeout(() => {
        const n = Math.floor(Math.random() * 64) + 1;
        const info = getQueInfo(n);
        const que = { ...info, num: n };
        openModal(que);
        saveToHistory(que);
      }, 700);
    });

    btnClose.addEventListener('click', closeModal);
    btnDrawAgain.addEventListener('click', () => { closeModal(); setTimeout(() => btnDraw.click(), 380); });

    // ================== L·ªäCH S·ª¨ ==================
    function saveToHistory(que) {
      let hist = JSON.parse(localStorage.getItem('queHistory') || '[]');
      hist.unshift(que);
      if (hist.length > 6) hist.pop();
      localStorage.setItem('queHistory', JSON.stringify(hist));
      renderHistory();
    }

    function renderHistory() {
      const hist = JSON.parse(localStorage.getItem('queHistory') || '[]');
      const section = document.getElementById('historySection');
      const list = document.getElementById('historyList');
      const count = document.getElementById('historyCount');

      if (hist.length === 0) {
        section.classList.add('hidden');
        return;
      }
      section.classList.remove('hidden');
      count.textContent = hist.length + '/6';

      list.innerHTML = hist.map(q => `
        <div onclick="loadOldQue(${q.num})" class="bg-white rounded-2xl p-4 shadow-sm cursor-pointer hover:shadow transition flex justify-between items-center">
          <div>
            <span class="font-semibold text-gray-900">Qu·∫ª ${q.num}</span>
            <p class="text-xs text-gray-500 mt-0.5">${q.name}</p>
          </div>
          <span class="text-xs px-3 py-1 rounded-full bg-${q.color}-100 text-${q.color}-700 font-medium">${q.type}</span>
        </div>
      `).join('');
    }

    window.loadOldQue = function(n) {
      const info = getQueInfo(n);
      openModal({ ...info, num: n });
    };

    // ================== AI ==================
    async function askAI(message) {
      const res = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message })
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || "L·ªói k·∫øt n·ªëi");
      return data.text || "";
    }

    btnAskAI.addEventListener('click', async () => {
      const q = aiQuestion.value.trim();
      if (!q || !currentQue) return;

      btnAskAI.disabled = true;
      btnAskAI.innerHTML = `<span class="inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></span>ƒêang h·ªèi AI...`;

      try {
        const prompt = `B·∫°n l√† th·∫ßy b√≥i t√†i l·ªôc ti·∫øng Vi·ªát, chuy√™n nghi·ªáp, g·∫ßn g≈©i.
Nhi·ªám v·ª•: di·ªÖn gi·∫£i qu·∫ª theo g√≥c nh√¨n th·ª±c t·∫ø, t√≠ch c·ª±c, ng·∫Øn g·ªçn 6-9 d√≤ng.
- Nh·∫•n m·∫°nh t√†i l·ªôc, c√¥ng vi·ªác, t√¨nh c·∫£m n·∫øu ph√π h·ª£p.
- ƒê∆∞a ra 3 l·ªùi khuy√™n c·ª• th·ªÉ.
Th√¥ng tin qu·∫ª:
S·ªë: ${currentQue.num} - ${currentQue.name}
M√¥ t·∫£: ${currentQue.meaning}
C√¢u h·ªèi ng∆∞·ªùi d√πng: ${q}`;

        const text = await askAI(prompt);
        aiAnswer.textContent = text || "AI ch∆∞a tr·∫£ l·ªùi ƒë∆∞·ª£c l√∫c n√†y.";
        aiAnswerBox.classList.remove('hidden');
      } catch (e) {
        aiAnswer.textContent = "‚ùå L·ªói k·∫øt n·ªëi AI. Vui l√≤ng th·ª≠ l·∫°i.";
        aiAnswerBox.classList.remove('hidden');
      } finally {
        btnAskAI.disabled = false;
        btnAskAI.textContent = "H·ªèi AI Di·ªÖn Gi·∫£i";
      }
    });

    // ================== SHARE ==================
    btnShare.addEventListener('click', async () => {
      const text = `ü™î Qu·∫ª c·ªßa t√¥i h√¥m nay:\nQu·∫ª ${currentQue.num} - ${currentQue.name}\n${currentQue.meaning}\n\nTh·ª≠ gieo qu·∫ª t√†i l·ªôc ngay!`;
      if (navigator.share) {
        await navigator.share({ title: "Gieo Qu·∫ª T√†i L·ªôc", text });
      } else {
        navigator.clipboard.writeText(text);
        alert("ƒê√£ copy k·∫øt qu·∫£ v√†o clipboard ‚úÖ");
      }
    });

    // ================== INIT ==================
    createSticks();
    renderHistory();

    // Tailwind script ch·∫°y
    document.documentElement.style.setProperty('--tw-ring-color', '#9F1239');
  </script>
</body>
</html>
