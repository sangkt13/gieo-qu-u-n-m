<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Gieo Quẻ Tài Lộc</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#D32F2F" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { margin: 0; padding: env(safe-area-inset-top) 0; background:#f5f5f5; }
    .app-wrap { min-height: 100vh; display:flex; align-items:center; justify-content:center; padding: 18px; }
    .card {
      width: 100%;
      max-width: 460px;
      border-radius: 22px;
      overflow: hidden;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%);
      position: relative;
    }
    .shine {
      position:absolute; inset:-60px;
      background: radial-gradient(circle at 20% 10%, rgba(255,255,255,.18), rgba(255,255,255,0) 55%);
      pointer-events:none;
    }

    /* “Ống lộc” đơn giản + animation rung */
    .tube {
      width: 150px; height: 250px;
      border-radius: 14px 14px 48px 48px;
      background: linear-gradient(90deg,#8D6E63 0%,#5D4037 25%,#4E342E 50%,#5D4037 75%,#8D6E63 100%);
      border: 4px solid #3E2723;
      box-shadow: inset 0 0 20px rgba(0,0,0,.6), 8px 10px 18px rgba(0,0,0,.25);
      position: relative;
      display:flex; align-items:center; justify-content:center;
      transform-origin: bottom center;
    }
    .tube::after{
      content:"LỘC";
      font-weight: 900;
      font-size: 42px;
      color:#FFC107;
      border: 2px solid #FFC107;
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(183,28,28,.65);
      text-shadow: 0 2px 6px rgba(0,0,0,.35);
    }
    .shake { animation: shake 650ms ease-in-out 1; }
    @keyframes shake {
      0% { transform: rotate(0deg); }
      15%{ transform: rotate(4deg); }
      30%{ transform: rotate(-6deg); }
      45%{ transform: rotate(6deg); }
      60%{ transform: rotate(-4deg); }
      75%{ transform: rotate(3deg); }
      100%{ transform: rotate(0deg); }
    }

    /* Modal */
    .overlay{
      position: fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.78);
      padding: 16px;
      z-index: 9999;
    }
    .overlay.show{ display:flex; }
    .modal{
      width: 100%;
      max-width: 420px;
      background:#fff;
      border-radius: 22px;
      border: 5px solid #FFC107;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      overflow:hidden;
    }
    .modal-head{
      background: linear-gradient(135deg, #fff7d1 0%, #fff 55%);
      padding: 16px 18px;
      border-bottom: 1px solid #f1f1f1;
    }
    .spinner{
      width: 18px; height: 18px;
      border-radius: 999px;
      border: 3px solid rgba(0,0,0,.15);
      border-top-color: rgba(0,0,0,.65);
      animation: spin 0.8s linear infinite;
      display:inline-block;
      vertical-align: -3px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    textarea { resize: none; }
  </style>
</head>

<body>
  <div class="app-wrap">
    <div class="card">
      <div class="shine"></div>

      <div class="p-5 text-center">
        <h1 class="text-[26px] font-black tracking-wide text-[#FFC107] drop-shadow">GIEO QUẺ TÀI LỘC</h1>
        <p class="text-white/90 text-sm mt-1">Lắc ống lộc và rút một quẻ may mắn</p>
      </div>

      <div class="px-6 pb-6">
        <div class="bg-white/10 rounded-2xl p-5">
          <div class="flex items-center justify-center py-6">
            <div id="tube" class="tube"></div>
          </div>

          <div class="flex flex-col gap-3">
            <button id="btnDraw"
              class="w-full rounded-xl bg-[#FFC107] text-black font-bold py-3 shadow hover:brightness-95 active:scale-[0.99] transition">
              Gieo quẻ ngay
            </button>

            <div class="text-xs text-white/80 text-center">
              Mẹo: bạn có thể hỏi AI “quẻ này hợp với công việc / tài lộc / tình cảm không?”
            </div>
          </div>
        </div>

        <div class="mt-4 text-center text-white/80 text-xs">
          PWA: có thể “Add to Home Screen” để dùng như app.
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modal-head">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-[#D32F2F] font-black text-xl">Kết quả gieo quẻ</div>
            <div class="text-sm text-gray-600 mt-0.5">Bạn có thể nhờ AI diễn giải theo bối cảnh.</div>
          </div>
          <button id="btnClose"
            class="shrink-0 rounded-lg px-3 py-2 bg-black/5 hover:bg-black/10 text-sm font-semibold">
            Đóng
          </button>
        </div>
      </div>

      <div class="p-4">
        <div class="rounded-2xl bg-gray-50 border p-4 text-center">
          <div class="text-sm text-gray-600">Số quẻ</div>
          <div id="resultNumber" class="text-5xl font-black text-gray-900 mt-1">--</div>
          <div id="resultText" class="text-sm text-gray-700 mt-3">
            (Mô tả ngắn sẽ hiển thị ở đây)
          </div>
        </div>

        <!-- AI BOX -->
        <div class="mt-4 rounded-2xl border p-4">
          <div class="flex items-center justify-between">
            <div class="font-bold text-gray-900">Giải thích bằng AI</div>
            <div id="aiStatus" class="text-xs text-gray-500"></div>
          </div>

          <label class="block text-sm text-gray-600 mt-3 mb-2">
            Bạn muốn hỏi gì về quẻ này?
          </label>
          <textarea id="aiQuestion"
            class="w-full rounded-xl border p-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#FFC107]"
            rows="3"
            placeholder="Ví dụ: Quẻ này báo hiệu gì cho công việc 3 tháng tới?"></textarea>

          <button id="btnAskAI"
            class="mt-3 w-full rounded-xl bg-[#D32F2F] text-white font-bold py-3 hover:brightness-95 active:scale-[0.99] transition">
            Hỏi AI
          </button>

          <div id="aiAnswerBox" class="mt-3 hidden">
            <div class="rounded-xl bg-gray-50 border p-3 text-sm text-gray-800 whitespace-pre-wrap" id="aiAnswer"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== SIMPLE “GIEO QUẺ” LOGIC (demo) ======
    const tube = document.getElementById("tube");
    const btnDraw = document.getElementById("btnDraw");
    const overlay = document.getElementById("overlay");
    const btnClose = document.getElementById("btnClose");
    const resultNumber = document.getElementById("resultNumber");
    const resultText = document.getElementById("resultText");

    // AI elements
    const btnAskAI = document.getElementById("btnAskAI");
    const aiQuestion = document.getElementById("aiQuestion");
    const aiAnswerBox = document.getElementById("aiAnswerBox");
    const aiAnswer = document.getElementById("aiAnswer");
    const aiStatus = document.getElementById("aiStatus");

    // Bạn có thể thay bằng nội dung quẻ thật của bạn
    const shortMeanings = [
      "Cát: Có tín hiệu tốt, nên chủ động nắm cơ hội.",
      "Bình: Tiến chậm mà chắc, ưu tiên ổn định.",
      "Hung: Tránh vội vàng, rà soát rủi ro trước khi quyết.",
      "Cát: Quý nhân phù trợ, thuận lợi khi hợp tác.",
      "Bình: Chờ thời, tích lũy nguồn lực.",
      "Cát: Tài lộc có thể đến từ kênh mới / ý tưởng mới."
    ];

    function randomInt(min, max){
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function openModal(){
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden", "false");
    }

    function closeModal(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden", "true");
    }

    btnClose.addEventListener("click", closeModal);
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) closeModal();
    });

    btnDraw.addEventListener("click", () => {
      tube.classList.remove("shake");
      void tube.offsetWidth; // reflow
      tube.classList.add("shake");

      const n = randomInt(1, 64); // ví dụ 1-64
      const meaning = shortMeanings[randomInt(0, shortMeanings.length - 1)];

      resultNumber.textContent = String(n);
      resultText.textContent = meaning;

      // reset AI box mỗi lần gieo
      aiQuestion.value = "";
      aiAnswer.textContent = "";
      aiAnswerBox.classList.add("hidden");
      aiStatus.textContent = "";

      openModal();
    });

    // ====== CHATGPT INTEGRATION (CALL /api/chat) ======
    async function askAI(message){
      const r = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message })
      });

      const data = await r.json().catch(() => ({}));
      if (!r.ok) {
        throw new Error(data?.error || "Request failed");
      }
      return data.text || "";
    }

    btnAskAI.addEventListener("click", async () => {
      const q = aiQuestion.value.trim();
      const n = resultNumber.textContent.trim();

      if (!n || n === "--") return;
      if (!q) {
        aiQuestion.focus();
        return;
      }

      btnAskAI.disabled = true;
      aiStatus.innerHTML = '<span class="spinner"></span> Đang hỏi AI...';

      try{
        const prompt =
`Bạn là trợ lý tiếng Việt.
Nhiệm vụ: diễn giải "quẻ gieo" theo hướng thực tế, ngắn gọn, dễ hiểu.
- Đưa ra 5-8 dòng.
- Có cảnh báo rủi ro (nếu có).
- Có 3 gợi ý hành động cụ thể.
Thông tin:
- Số quẻ: ${n}
- Mô tả ngắn: ${resultText.textContent}
- Câu hỏi người dùng: ${q}`;

        const text = await askAI(prompt);

        aiAnswer.textContent = text || "(AI không trả về nội dung)";
        aiAnswerBox.classList.remove("hidden");
        aiStatus.textContent = "Xong ✅";
      } catch(err){
        aiAnswer.textContent = "Lỗi: " + (err?.message || String(err));
        aiAnswerBox.classList.remove("hidden");
        aiStatus.textContent = "Có lỗi ❌";
      } finally{
        btnAskAI.disabled = false;
      }
    });

    // ====== (Optional) Service Worker registration nếu bạn có sw.js ======
    // if ("serviceWorker" in navigator) {
    //   window.addEventListener("load", () => {
    //     navigator.serviceWorker.register("/sw.js").catch(() => {});
    //   });
    // }
  </script>
</body>
</html>
